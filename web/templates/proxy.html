{{define "content"}}
<style>
/* ── Proxy page extras ─────────────────────────────────────────────────── */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.65);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
}
.modal-box {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 2rem; width: 420px; max-width: 90vw;
    box-shadow: 0 8px 32px rgba(0,0,0,.45);
}
.modal-box h2 { margin: 0 0 1.25rem; font-size: 1.1rem; }
.modal-actions { display: flex; gap: .75rem; justify-content: flex-end; margin-top: 1.25rem; }

.project-label {
    font-size: .78rem; font-weight: 600; letter-spacing: .04em;
    background: rgba(99,102,241,.15); color: var(--accent);
    padding: .25rem .7rem; border-radius: 20px; border: 1px solid rgba(99,102,241,.3);
}

.proxy-filter-bar {
    display: flex; align-items: center; gap: .65rem; flex-wrap: wrap; margin-bottom: .75rem;
}
.proxy-filter-bar .input { flex: 1; min-width: 110px; max-width: 200px; }
.proxy-filter-bar .input-op { flex: 2; min-width: 150px; max-width: 300px; }
#traffic-count { margin-left: auto; white-space: nowrap; flex-shrink: 0; }

.traffic-scroll { max-height: 44vh; overflow-y: auto; }
.traffic-scroll thead th {
    position: sticky; top: 0; z-index: 1;
    background: var(--bg-card); box-shadow: 0 1px 0 var(--border);
}

.detail-outer { max-height: 38vh; overflow-y: auto; padding: 1rem 1.25rem; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
@media (max-width: 900px) { .detail-grid { grid-template-columns: 1fr; } }
.detail-outer pre.code-block {
    max-height: 180px; overflow: auto; white-space: pre-wrap;
    word-break: break-all; margin: 0;
}

.selected-row td { background: rgba(99,102,241,.1); }
.selected-row td:first-child { border-left: 2px solid var(--accent); }
@keyframes rowFlash { from { background: rgba(34,197,94,.25); } to {} }
.row-new td { animation: rowFlash 1.4s ease-out; }
</style>

<!-- ── Project name modal ──────────────────────────────────────────────── -->
<div id="start-modal" class="modal-overlay" style="display:none"
     onclick="if(event.target===this)closeModal()">
    <div class="modal-box">
        <h2>New Proxy Session</h2>
        <div style="margin-bottom:.85rem">
            <label class="label" style="display:block;margin-bottom:.4rem">Project Name</label>
            <input class="input" id="proj-input" type="text"
                   placeholder="e.g. walmart-gql-recon" style="width:100%">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmStart()">Start Proxy</button>
        </div>
    </div>
</div>

<!-- ── Page header ────────────────────────────────────────────────────── -->
<div class="page-header">
    <div style="display:flex;align-items:center;gap:.85rem;flex-wrap:wrap">
        <h1>MITM Proxy</h1>
        {{if .CurrentProject}}
        <span class="project-label">{{.CurrentProject}}</span>
        {{end}}
    </div>
    <div class="page-actions">
        {{if .ProxyRunning}}
        <span class="badge badge-active">Running On {{.ProxyAddr}}</span>
        <button class="btn btn-danger" onclick="proxyStop()">Stop Proxy</button>
        {{else}}
        <span class="badge badge-inactive">Stopped</span>
        <button class="btn btn-primary" onclick="openStartModal()">Start Proxy</button>
        {{end}}
        <button class="btn" onclick="clearTraffic()">Clear Traffic</button>
    </div>
</div>

<!-- ── Setup card ─────────────────────────────────────────────────────── -->
<div class="card" style="margin-bottom:1rem">
    <div class="card-header"><h2>Setup Instructions</h2></div>
    <div class="card-body">
        <p>1. Install the CA certificate: <code>~/.gqlforge/ca.pem</code></p>
        <p>2. Configure your browser/tool proxy to:
           <code>{{if .ProxyAddr}}{{.ProxyAddr}}{{else}}:8888{{end}}</code></p>
        <p>3. Browse any GraphQL API &mdash; requests will appear below automatically.</p>
    </div>
</div>

<!-- ── Filter bar ─────────────────────────────────────────────────────── -->
<div class="proxy-filter-bar">
    <select id="f-method" class="input" onchange="applyFilters()">
        <option value="">All Methods</option>
    </select>
    <select id="f-host" class="input" onchange="applyFilters()">
        <option value="">All Hosts</option>
    </select>
    <input id="f-op" class="input input-op" type="text"
           placeholder="Filter operation..." oninput="applyFilters()">
    <select id="f-status" class="input" onchange="applyFilters()">
        <option value="">All Status</option>
    </select>
    <span id="traffic-count" class="badge">0 requests</span>
</div>

<!-- ── Traffic table (scrollable, fixed height) ───────────────────────── -->
<div class="card" style="margin-bottom:1rem">
    <div class="card-header"><h2>Captured GraphQL Traffic</h2></div>
    <div class="traffic-scroll">
        <table class="table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Method</th>
                    <th>Host</th>
                    <th>Operation</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="traffic-body">
                <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">
                    Loading&hellip;
                </td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ── Request detail panel (fixed height, scrollable) ────────────────── -->
<div id="detail-panel" class="card" style="display:none;margin-bottom:1rem">
    <div class="card-header">
        <h2>Request Detail</h2>
        <button class="btn" style="padding:.25rem .7rem;font-size:.8rem"
                onclick="closeDetail()">&#x2715; Close</button>
    </div>
    <div class="detail-outer">
        <div class="detail-grid" id="detail-body"></div>
    </div>
</div>

<script>
const proxyRunning = {{if .ProxyRunning}}true{{else}}false{{end}};
let allTraffic = [];
let selectedId  = null;
const filters   = { method: '', host: '', op: '', status: '' };

// ── Helpers ───────────────────────────────────────────────────────────────
function escH(s) {
    const d = document.createElement('div');
    d.textContent = String(s ?? '');
    return d.innerHTML;
}
function escA(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;')
                          .replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Load initial traffic ──────────────────────────────────────────────────
fetch('/api/proxy/traffic?limit=2000')
    .then(r => r.json())
    .then(data => { allTraffic = Array.isArray(data) ? data : []; buildOptions(); renderTable(); })
    .catch(() => { allTraffic = []; renderTable(); });

// ── SSE: live updates while proxy is running ──────────────────────────────
if (proxyRunning) {
    const sse = new EventSource('/api/proxy/sse');
    sse.onmessage = e => {
        try {
            const req = JSON.parse(e.data);
            allTraffic.unshift(req);
            buildOptions();
            renderTable();
            requestAnimationFrame(() => {
                const first = document.querySelector('#traffic-body tr:first-child');
                if (first) { first.classList.remove('row-new'); void first.offsetWidth; first.classList.add('row-new'); }
            });
        } catch (_) {}
    };
    sse.onerror = () => {};
}

// ── Auto-detect filter options from live data ─────────────────────────────
function buildOptions() {
    const methods  = [...new Set(allTraffic.map(t => t.method).filter(Boolean))].sort();
    const hosts    = [...new Set(allTraffic.map(t => t.host).filter(Boolean))].sort();
    const statuses = [...new Set(allTraffic.map(t => t.responseCode).filter(Boolean))].sort((a,b) => a - b);
    fillSelect('f-method', methods,  'All Methods');
    fillSelect('f-host',   hosts,    'All Hosts');
    fillSelect('f-status', statuses, 'All Status');
}

function fillSelect(id, values, placeholder) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    sel.innerHTML = `<option value="">${placeholder}</option>` +
        values.map(v => `<option value="${escA(v)}"${String(v) === cur ? ' selected' : ''}>${escA(String(v))}</option>`).join('');
}

// ── Apply column filters ──────────────────────────────────────────────────
function applyFilters() {
    filters.method = document.getElementById('f-method').value;
    filters.host   = document.getElementById('f-host').value;
    filters.op     = document.getElementById('f-op').value.toLowerCase();
    filters.status = document.getElementById('f-status').value;
    renderTable();
}

// ── Render filtered table ─────────────────────────────────────────────────
function renderTable() {
    const visible = allTraffic.filter(t => {
        if (filters.method && t.method !== filters.method) return false;
        if (filters.host   && t.host   !== filters.host)   return false;
        if (filters.op     && !(t.operationName || '').toLowerCase().includes(filters.op)) return false;
        if (filters.status && String(t.responseCode) !== filters.status) return false;
        return true;
    });

    document.getElementById('traffic-count').textContent =
        visible.length + ' request' + (visible.length !== 1 ? 's' : '');

    const tbody = document.getElementById('traffic-body');
    if (visible.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">${
            allTraffic.length === 0 ? 'No traffic captured yet.' : 'No matching traffic.'
        }</td></tr>`;
        return;
    }

    tbody.innerHTML = visible.map(t => {
        const ts  = new Date(t.timestamp).toLocaleTimeString();
        const sel = selectedId === t.id;
        const ok  = t.responseCode < 400;
        const op  = t.operationName
            ? `<span class="op-name">${escH(t.operationName)}</span>`
            : `<span class="op-anonymous">anonymous</span>`;
        return `<tr class="clickable${sel ? ' selected-row' : ''}" onclick="selectRow('${t.id}')">
            <td>${ts}</td><td>${escH(t.method)}</td><td>${escH(t.host)}</td>
            <td>${op}</td>
            <td><span class="status-code status-${ok?'ok':'err'}">${t.responseCode}</span></td>
        </tr>`;
    }).join('');
}

// ── Request detail ────────────────────────────────────────────────────────
function selectRow(id) {
    selectedId = id;
    renderTable();
    const req = allTraffic.find(t => t.id === id);
    if (!req) return;
    const panel = document.getElementById('detail-panel');
    panel.style.display = 'block';
    document.getElementById('detail-body').innerHTML = `
        <div class="detail-section">
            <h3>Query</h3>
            <pre class="code-block">${escH(req.query || 'N/A')}</pre>
        </div>
        <div class="detail-section">
            <h3>Variables</h3>
            <pre class="code-block">${escH(JSON.stringify(req.variables, null, 2) || '{}')}</pre>
        </div>
        <div class="detail-section">
            <h3>Headers</h3>
            <pre class="code-block">${escH(JSON.stringify(req.headers, null, 2) || '{}')}</pre>
        </div>`;
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function closeDetail() {
    document.getElementById('detail-panel').style.display = 'none';
    selectedId = null;
    renderTable();
}

// ── Proxy controls ────────────────────────────────────────────────────────
function openStartModal() {
    document.getElementById('start-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('proj-input').focus(), 60);
}
function closeModal() {
    document.getElementById('start-modal').style.display = 'none';
}
function confirmStart() {
    const name = document.getElementById('proj-input').value.trim() || 'Session';
    fetch('/api/proxy/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectName: name }),
    })
    .then(r => r.json())
    .then(d => { if (!d.error) location.reload(); else alert(d.error); })
    .catch(e => alert(e.message));
}
document.addEventListener('DOMContentLoaded', () => {
    const pi = document.getElementById('proj-input');
    if (pi) {
        pi.addEventListener('keydown', e => {
            if (e.key === 'Enter')  confirmStart();
            if (e.key === 'Escape') closeModal();
        });
    }
});
function proxyStop() {
    fetch('/api/proxy/stop', { method: 'POST' }).then(() => location.reload());
}
function clearTraffic() {
    fetch('/api/proxy/traffic', { method: 'DELETE' }).then(() => {
        allTraffic = []; buildOptions(); renderTable(); closeDetail();
    });
}
</script>
{{end}}
