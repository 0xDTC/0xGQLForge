{{define "content"}}
<style>
/* ── Proxy page extras ─────────────────────────────────────────────────── */
.project-label {
    font-size: .78rem; font-weight: 600; letter-spacing: .04em;
    background: rgba(99,102,241,.15); color: var(--accent);
    padding: .25rem .7rem; border-radius: 20px; border: 1px solid rgba(99,102,241,.3);
}

.traffic-scroll { max-height: 44vh; overflow-y: auto; }
.traffic-scroll thead th {
    position: sticky; top: 0; z-index: 1;
    background: var(--bg-card); box-shadow: 0 1px 0 var(--border);
    vertical-align: top; padding-bottom: .5rem;
}

/* Inline column filters inside <th> */
.th-filter, .th-filter-input {
    display: block; width: 100%; margin-top: .3rem;
    padding: .18rem .3rem; font-size: .68rem; font-weight: 400;
    text-transform: none; letter-spacing: 0;
    color: var(--text-primary); background: var(--bg-input);
    border: 1px solid var(--border); border-radius: 4px;
    outline: none; box-sizing: border-box;
}
.th-filter { cursor: pointer; }
.th-filter:focus, .th-filter-input:focus { border-color: var(--accent); }

.detail-outer { max-height: 38vh; overflow-y: auto; padding: 1rem 1.25rem; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
@media (max-width: 900px) { .detail-grid { grid-template-columns: 1fr; } }
.detail-outer pre.code-block {
    max-height: 180px; overflow: auto; white-space: pre-wrap;
    word-break: break-all; margin: 0;
}

.selected-row td { background: rgba(99,102,241,.1); }
.selected-row td:first-child { border-left: 2px solid var(--accent); }
@keyframes rowFlash { from { background: rgba(34,197,94,.25); } to {} }
.row-new td { animation: rowFlash 1.4s ease-out; }
</style>

<!-- ── Page header ────────────────────────────────────────────────────── -->
<div class="page-header">
    <div style="display:flex;align-items:center;gap:.85rem;flex-wrap:wrap">
        <h1>MITM Proxy</h1>
        <span id="proxy-project-label" style="display:none" class="project-label"></span>
    </div>
    <div class="page-actions">
        <span id="proxy-badge" class="badge badge-inactive">Stopped</span>
        <button id="btn-start" class="btn btn-primary" onclick="startProxy()">Start Proxy</button>
        <button id="btn-stop"  class="btn btn-danger"  onclick="stopProxy()" style="display:none">Stop Proxy</button>
        <button class="btn" onclick="clearTraffic()">Clear Traffic</button>
    </div>
</div>

<!-- ── Setup card ─────────────────────────────────────────────────────── -->
<div class="card" style="margin-bottom:1rem">
    <div class="card-header"><h2>Setup Instructions</h2></div>
    <div class="card-body">
        <p>1. Install the CA certificate: <code>~/.gqlforge/ca.pem</code></p>
        <p>2. Configure your browser/tool proxy to: <code id="proxy-addr-hint">:8888</code></p>
        <p>3. Browse any GraphQL API &mdash; requests will appear below automatically.</p>
    </div>
</div>

<!-- ── Link to project ──────────────────────────────────────────────────── -->
<div class="card" style="margin-bottom:1rem">
    <div class="card-header"><h2>Link to Project</h2></div>
    <div class="card-body">
        <div style="display:flex;align-items:center;gap:.65rem;flex-wrap:wrap;margin-bottom:.5rem">
            <select id="project-select" class="input" style="min-width:200px">
                <option value="">&#8212; None &#8212;</option>
            </select>
            <button class="btn btn-primary" onclick="applyProject()">Apply</button>
            <a href="/projects" class="btn">Manage Projects</a>
        </div>
        <p style="color:var(--text-muted);font-size:.8rem;margin:0">
            Traffic captured while the proxy is running will be saved to the selected project.
        </p>
    </div>
</div>

<!-- ── Traffic table (scrollable, fixed height) ───────────────────────── -->
<div class="card" style="margin-bottom:1rem">
    <div class="card-header">
        <h2>Captured GraphQL Traffic</h2>
        <span id="traffic-count" class="badge">0 requests</span>
    </div>
    <div class="traffic-scroll">
        <table class="table">
            <thead>
                <tr>
                    <th style="min-width:70px">Time</th>
                    <th style="min-width:90px">
                        Method
                        <select class="th-filter" id="f-method" onchange="applyFilters()">
                            <option value="">All</option>
                        </select>
                    </th>
                    <th style="min-width:140px">
                        Host
                        <select class="th-filter" id="f-host" onchange="applyFilters()">
                            <option value="">All</option>
                        </select>
                    </th>
                    <th style="min-width:140px">
                        Operation
                        <input class="th-filter-input" id="f-op" type="text"
                               placeholder="filter&#x2026;" oninput="applyFilters()">
                    </th>
                    <th style="min-width:70px">
                        Status
                        <select class="th-filter" id="f-status" onchange="applyFilters()">
                            <option value="">All</option>
                        </select>
                    </th>
                </tr>
            </thead>
            <tbody id="traffic-body">
                <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">
                    Loading&hellip;
                </td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ── Request detail panel (fixed height, scrollable) ────────────────── -->
<div id="detail-panel" class="card" style="display:none;margin-bottom:1rem">
    <div class="card-header">
        <h2>Request Detail</h2>
        <button class="btn" style="padding:.25rem .7rem;font-size:.8rem"
                onclick="closeDetail()">&#x2715; Close</button>
    </div>
    <div class="detail-outer">
        <div class="detail-grid" id="detail-body"></div>
    </div>
</div>

<script>
let allTraffic = [];
let selectedId  = null;
const filters   = { method: '', host: '', op: '', status: '' };
let sseSource   = null;

// ── Helpers ───────────────────────────────────────────────────────────────
function escH(s) {
    const d = document.createElement('div');
    d.textContent = String(s ?? '');
    return d.innerHTML;
}
function escA(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;')
                          .replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ── Update proxy UI state (no page reload) ────────────────────────────────
function setProxyRunning(running, addr) {
    document.getElementById('btn-start').style.display = running ? 'none' : '';
    document.getElementById('btn-stop').style.display  = running ? '' : 'none';
    const badge = document.getElementById('proxy-badge');
    if (running) {
        badge.className = 'badge badge-active';
        badge.textContent = 'Running on ' + (addr || '');
        document.getElementById('proxy-addr-hint').textContent = addr || ':8888';
    } else {
        badge.className = 'badge badge-inactive';
        badge.textContent = 'Stopped';
    }
}

// ── SSE: connect once proxy is running, auto-close on stop ────────────────
function connectSSE() {
    if (sseSource) { sseSource.close(); sseSource = null; }
    const src = new EventSource('/api/proxy/sse');
    src.onmessage = e => {
        try {
            const req = JSON.parse(e.data);
            if (!req || !req.id) return;
            allTraffic.unshift(req);
            buildOptions();
            renderTable();
            requestAnimationFrame(() => {
                const first = document.querySelector('#traffic-body tr:first-child');
                if (first) {
                    first.classList.remove('row-new');
                    void first.offsetWidth;
                    first.classList.add('row-new');
                }
            });
        } catch (_) {}
    };
    src.onerror = () => {};
    sseSource = src;
}

// ── Start / Stop ──────────────────────────────────────────────────────────
function startProxy() {
    const btn = document.getElementById('btn-start');
    btn.disabled = true;
    fetch('/api/proxy/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{}',
    })
    .then(r => r.json())
    .then(d => {
        btn.disabled = false;
        if (d.error) { alert(d.error); return; }
        setProxyRunning(true, d.addr);
        connectSSE();
    })
    .catch(e => { btn.disabled = false; alert(e.message); });
}

function stopProxy() {
    fetch('/api/proxy/stop', { method: 'POST' })
        .then(() => {
            setProxyRunning(false, '');
            if (sseSource) { sseSource.close(); sseSource = null; }
        });
}

// ── Project dropdown ──────────────────────────────────────────────────────
function loadProjects() {
    fetch('/api/projects')
        .then(r => r.json())
        .then(projects => {
            const sel = document.getElementById('project-select');
            const cur = sel.value;
            sel.innerHTML = '<option value="">&#8212; None &#8212;</option>' +
                (projects || []).map(p =>
                    `<option value="${escA(p.id)}"${p.id === cur ? ' selected' : ''}>${escA(p.name)}</option>`
                ).join('');
        })
        .catch(() => {});
}

function applyProject() {
    const projectId = document.getElementById('project-select').value;
    fetch('/api/proxy/project', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ projectId }),
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) { alert(d.error); return; }
        const sel  = document.getElementById('project-select');
        const name = sel.options[sel.selectedIndex].text;
        const lbl  = document.getElementById('proxy-project-label');
        if (projectId) { lbl.textContent = name; lbl.style.display = ''; }
        else            { lbl.style.display = 'none'; }
    })
    .catch(e => alert(e.message));
}

// ── Load initial traffic + status ─────────────────────────────────────────
async function init() {
    try {
        const s = await fetch('/api/proxy/status').then(r => r.json());
        setProxyRunning(s.running, s.addr);
        if (s.running) connectSSE();
    } catch (_) {}

    try {
        const data = await fetch('/api/proxy/traffic?limit=2000').then(r => r.json());
        allTraffic = Array.isArray(data) ? data : [];
    } catch (_) { allTraffic = []; }

    buildOptions();
    renderTable();
    loadProjects();
}
init();

// ── Auto-detect filter options from live data ─────────────────────────────
function buildOptions() {
    const methods  = [...new Set(allTraffic.map(t => t.method).filter(Boolean))].sort();
    const hosts    = [...new Set(allTraffic.map(t => t.host).filter(Boolean))].sort();
    const statuses = [...new Set(allTraffic.map(t => t.responseCode).filter(Boolean))].sort((a,b) => a - b);
    fillSelect('f-method', methods,  'All');
    fillSelect('f-host',   hosts,    'All');
    fillSelect('f-status', statuses, 'All');
}

function fillSelect(id, values, placeholder) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    sel.innerHTML = `<option value="">${placeholder}</option>` +
        values.map(v => `<option value="${escA(v)}"${String(v) === cur ? ' selected' : ''}>${escA(String(v))}</option>`).join('');
}

// ── Apply column filters ──────────────────────────────────────────────────
function applyFilters() {
    filters.method = document.getElementById('f-method').value;
    filters.host   = document.getElementById('f-host').value;
    filters.op     = document.getElementById('f-op').value.toLowerCase();
    filters.status = document.getElementById('f-status').value;
    renderTable();
}

// ── Render filtered table ─────────────────────────────────────────────────
function renderTable() {
    const visible = allTraffic.filter(t => {
        if (filters.method && t.method !== filters.method) return false;
        if (filters.host   && t.host   !== filters.host)   return false;
        if (filters.op     && !(t.operationName || '').toLowerCase().includes(filters.op)) return false;
        if (filters.status && String(t.responseCode) !== filters.status) return false;
        return true;
    });

    document.getElementById('traffic-count').textContent =
        visible.length + ' request' + (visible.length !== 1 ? 's' : '');

    const tbody = document.getElementById('traffic-body');
    if (visible.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">${
            allTraffic.length === 0 ? 'No traffic captured yet.' : 'No matching traffic.'
        }</td></tr>`;
        return;
    }

    tbody.innerHTML = visible.map(t => {
        const ts  = new Date(t.timestamp).toLocaleTimeString();
        const sel = selectedId === t.id;
        const ok  = t.responseCode < 400;
        const op  = t.operationName
            ? `<span class="op-name">${escH(t.operationName)}</span>`
            : `<span class="op-anonymous">anonymous</span>`;
        return `<tr class="clickable${sel ? ' selected-row' : ''}" onclick="selectRow('${escA(t.id)}')">
            <td>${ts}</td><td>${escH(t.method)}</td><td>${escH(t.host)}</td>
            <td>${op}</td>
            <td><span class="status-code status-${ok?'ok':'err'}">${t.responseCode}</span></td>
        </tr>`;
    }).join('');
}

// ── Request detail ────────────────────────────────────────────────────────
function selectRow(id) {
    selectedId = id;
    renderTable();
    const req = allTraffic.find(t => t.id === id);
    if (!req) return;
    const panel = document.getElementById('detail-panel');
    panel.style.display = 'block';
    document.getElementById('detail-body').innerHTML = `
        <div class="detail-section">
            <h3>Query</h3>
            <pre class="code-block">${escH(req.query || 'N/A')}</pre>
        </div>
        <div class="detail-section">
            <h3>Variables</h3>
            <pre class="code-block">${escH(JSON.stringify(req.variables, null, 2) || '{}')}</pre>
        </div>
        <div class="detail-section">
            <h3>Headers</h3>
            <pre class="code-block">${escH(JSON.stringify(req.headers, null, 2) || '{}')}</pre>
        </div>`;
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeDetail() {
    document.getElementById('detail-panel').style.display = 'none';
    selectedId = null;
    renderTable();
}

// ── Clear traffic ─────────────────────────────────────────────────────────
function clearTraffic() {
    fetch('/api/proxy/traffic', { method: 'DELETE' }).then(() => {
        allTraffic = []; buildOptions(); renderTable(); closeDetail();
    });
}
</script>
{{end}}
