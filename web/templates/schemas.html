{{define "content"}}
<!-- ── Page header ─────────────────────────────────────────────────────── -->
<div class="page-header">
    <h1>Schemas</h1>
</div>

<!-- ── Upload card ────────────────────────────────────────────────────── -->
<div class="card" style="margin-bottom:1.25rem">
    <div class="card-header"><h2>Import Introspection JSON</h2></div>
    <div class="card-body">
        <div class="form-group">
            <label for="schema-name">Schema Name (optional)</label>
            <input type="text" id="schema-name" placeholder="e.g. target-api" class="input" style="max-width:320px">
        </div>
        <div class="form-group">
            <label for="introspection-input">Introspection JSON</label>
            <textarea id="introspection-input" class="textarea" rows="10"
                placeholder='Paste your introspection query result JSON here...&#10;&#10;Supports:&#10;  {"data":{"__schema":{...}}}&#10;  {"__schema":{...}}&#10;  {"queryType":{...},"types":[]}'></textarea>
        </div>
        <button id="parse-btn" class="btn btn-primary" onclick="parseIntrospection()">Parse &amp; Import</button>
        <div id="parse-result" class="parse-result" style="display:none"></div>
    </div>
</div>

<!-- ── Schemas list ────────────────────────────────────────────────────── -->
{{if .Schemas}}
<div class="card">
    <div class="card-header"><h2>Stored Schemas <span style="color:var(--text-muted);font-weight:400;font-size:.8rem">({{len .Schemas}})</span></h2></div>
    <div class="card-body" style="padding:0">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Source</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .Schemas}}
                <tr>
                    <td><a href="/schema/{{.ID}}" style="color:var(--accent);text-decoration:none;font-weight:500">{{.Name}}</a></td>
                    <td><span class="badge badge-{{.Source}}">{{.Source}}</span></td>
                    <td style="color:var(--text-muted);font-size:.8rem">{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                    <td>
                        <a href="/schema/{{.ID}}" class="btn btn-sm">Explore</a>
                        <a href="/schema/{{.ID}}/graph" class="btn btn-sm">Graph</a>
                        <a href="/generator/{{.ID}}" class="btn btn-sm">Generator</a>
                        <a href="/analysis/{{.ID}}" class="btn btn-sm btn-danger">Analyze</a>
                        <button class="btn btn-sm" onclick="deleteSchema('{{.ID}}')" style="color:var(--text-muted)">Delete</button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>
{{else}}
<div class="empty-state">
    <p>No schemas yet. Paste introspection JSON above or run a proxy session to auto-infer one.</p>
</div>
{{end}}

<script>
function parseIntrospection() {
    const input = document.getElementById('introspection-input').value.trim();
    const name  = document.getElementById('schema-name').value.trim();
    const resultDiv = document.getElementById('parse-result');
    const btn = document.getElementById('parse-btn');

    if (!input) {
        resultDiv.style.display = 'block';
        resultDiv.className = 'parse-result error';
        resultDiv.textContent = 'Please paste introspection JSON first.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Parsing...';

    let url = '/api/introspection';
    if (name) url += '?name=' + encodeURIComponent(name);

    fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: input })
        .then(r => r.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = 'Parse & Import';
            resultDiv.style.display = 'block';
            if (data.error) {
                resultDiv.className = 'parse-result error';
                resultDiv.textContent = 'Error: ' + data.error;
            } else {
                resultDiv.className = 'parse-result success';
                resultDiv.innerHTML = `Imported: ${data.typeCount} types, ${data.queryCount} queries, ${data.mutationCount} mutations. <a href="${data.redirectURL}">View Schema &rarr;</a>`;
                setTimeout(() => { window.location.href = data.redirectURL; }, 1500);
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.textContent = 'Parse & Import';
            resultDiv.style.display = 'block';
            resultDiv.className = 'parse-result error';
            resultDiv.textContent = 'Network error: ' + err.message;
        });
}

function deleteSchema(id) {
    if (!confirm('Delete this schema? This cannot be undone.')) return;
    fetch('/api/schema/' + id, { method: 'DELETE' })
        .then(() => location.reload())
        .catch(e => alert(e.message));
}
</script>
{{end}}
